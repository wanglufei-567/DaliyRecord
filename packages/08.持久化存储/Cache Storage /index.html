<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8" />
        <title>Cache Storage ç¤ºä¾‹</title>
    </head>
    <body>
        <h1>Cache Storage ç¤ºä¾‹</h1>
        <button id="cache-btn">ç¼“å­˜å¹¶è¯»å–æ•°æ®</button>

        <pre id="output"></pre>

        <script>
            // å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œç”¨äºæ¼”ç¤º Cache Storage çš„ç”¨æ³•
            async function cacheExample() {
                const cacheName = 'my-cache' // ç¼“å­˜åç§°
                const requestUrl = './example.json' // éœ€è¦ç¼“å­˜çš„èµ„æºè·¯å¾„ï¼Œéœ€ä¸æœ¬ HTML æ–‡ä»¶åŒç›®å½•

                const output = document.getElementById('output') // è·å–è¾“å‡ºåŒºåŸŸ

                try {
                    // caches æ˜¯æµè§ˆå™¨æä¾›çš„å…¨å±€ CacheStorage å¯¹è±¡ï¼Œç”¨äºç®¡ç†ç¼“å­˜
                    // open æ–¹æ³•ç”¨äºæ‰“å¼€ä¸€ä¸ªæŒ‡å®šåç§°çš„ç¼“å­˜ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™æ–°å»ºï¼‰ï¼Œè¿”å›ä¸€ä¸ª Promiseï¼Œè§£æä¸º Cache å®ä¾‹
                    // open æ–¹æ³•çš„å‚æ•°ä¸ºç¼“å­˜åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå¦‚ 'my-cache'
                    const cache = await caches.open(cacheName)

                    // å…ˆè·å–èµ„æºå†…å®¹
                    const response = await fetch(requestUrl)

                    // cache.put ç”¨äºå°†è¯·æ±‚å’Œå“åº”å¯¹è±¡å­˜å…¥ç¼“å­˜
                    // put æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¯·æ±‚ï¼ˆRequest å¯¹è±¡æˆ– URL å­—ç¬¦ä¸²ï¼‰ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå“åº”ï¼ˆResponse å¯¹è±¡ï¼‰
                    // ç”±äº response åªèƒ½è¢«è¯»å–ä¸€æ¬¡ï¼Œè¿™é‡Œç”¨ response.clone() è¿›è¡Œå…‹éš†ï¼Œé¿å…åç»­è¯»å–å‡ºé”™
                    // è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª Promiseï¼Œè¡¨ç¤ºç¼“å­˜æ“ä½œå®Œæˆ
                    await cache.put(requestUrl, response.clone())

                    output.textContent += 'âœ… å·²å°† example.json åŠ å…¥ç¼“å­˜\n'

                    setTimeout(async () => {
                        // cache.match ç”¨äºæŸ¥æ‰¾ç¼“å­˜ä¸­ä¸æŒ‡å®šè¯·æ±‚åŒ¹é…çš„å“åº”
                        // å‚æ•°å¯ä»¥æ˜¯ Request å¯¹è±¡æˆ– URL å­—ç¬¦ä¸²ï¼Œè¿™é‡Œç”¨çš„æ˜¯ URL å­—ç¬¦ä¸²
                        // è¿”å›å€¼æ˜¯ä¸€ä¸ª Promiseï¼Œè§£æä¸ºåŒ¹é…åˆ°çš„ Response å¯¹è±¡ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¸º undefinedï¼‰
                        const cachedResponse = await cache.match(requestUrl)
                        if (cachedResponse) {
                            // è§£æç¼“å­˜ä¸­çš„ JSON æ•°æ®
                            const data = await cachedResponse.json()
                            output.textContent +=
                                'ğŸ“¦ ç¼“å­˜å†…å®¹ï¼š\n' + JSON.stringify(data, null, 2) + '\n'
                        } else {
                            output.textContent += 'âŒ æœªæ‰¾åˆ°ç¼“å­˜å†…å®¹\n'
                        }

                        // æ¸…é™¤æ•´ä¸ªç¼“å­˜ï¼ˆå¯é€‰æ“ä½œï¼‰
                        const deleted = await caches.delete(cacheName)
                        output.textContent += deleted ? 'ğŸ—‘ï¸ ç¼“å­˜å·²æ¸…é™¤\n' : 'âš ï¸ ç¼“å­˜æ¸…é™¤å¤±è´¥\n'
                    }, 5000)

                } catch (err) {
                    // æ•è·å¹¶è¾“å‡ºé”™è¯¯ä¿¡æ¯
                    output.textContent += 'âŒ é”™è¯¯: ' + err + '\n'
                }
            }

            // ç»™æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œè§¦å‘ç¼“å­˜ç¤ºä¾‹å‡½æ•°
            document.getElementById('cache-btn').addEventListener('click', cacheExample)
        </script>
    </body>
</html>
